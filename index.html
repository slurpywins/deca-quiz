<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DECA Learning Platform</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  
  <style>
    :root {
      --primary-color: #0056A4;
      --primary-hover: #004080;
      --secondary-color: #3A7DC0;
      --success-color: #10B981;
      --danger-color: #EF4444;
      --warning-color: #F59E0B;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--gray-100);
      color: var(--gray-800);
      line-height: 1.5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      min-height: 100vh;
      position: relative;
    }
    
    .page {
      display: none;
      width: 100%;
      padding: 20px 0;
    }
    
    /* Login Page Styles */
    .auth-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 0;
    }
    
    .auth-container {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 430px;
      padding: 30px;
      margin-bottom: 20px;
    }
    
    .logo-container {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .auth-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
      color: var(--gray-900);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--gray-700);
      font-size: 14px;
    }
    
    .input-group {
      position: relative;
    }
    
    .input-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
    }
    
    .form-input {
      width: 100%;
      padding: 10px 12px 10px 38px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
      outline: none;
    }
    
    .form-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 86, 164, 0.1);
    }
    
    .form-input.error {
      border-color: var(--danger-color);
    }
    
    .error-message {
      color: var(--danger-color);
      font-size: 12px;
      margin-top: 4px;
    }
    
    .remember-forgot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .remember-me {
      display: flex;
      align-items: center;
    }
    
    .remember-me input {
      margin-right: 6px;
    }
    
    .forgot-password {
      color: var(--primary-color);
      text-decoration: none;
    }
    
    .forgot-password:hover {
      text-decoration: underline;
    }
    
    .btn {
      display: inline-block;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-hover);
    }
    
    .btn-outline {
      border: 1px solid var(--gray-300);
      background-color: white;
      color: var(--gray-700);
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .btn-outline:hover {
      background-color: var(--gray-100);
    }
    
    .btn-outline img, .btn-outline svg {
      margin-right: 10px;
      height: 18px;
    }
    
    .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
    }
    
    .divider-line {
      flex-grow: 1;
      height: 1px;
      background-color: var(--gray-300);
    }
    
    .divider-text {
      padding: 0 10px;
      color: var(--gray-500);
      font-size: 14px;
    }
    
    .auth-footer {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: var(--gray-600);
    }
    
    .auth-link {
      color: var(--primary-color);
      text-decoration: none;
      cursor: pointer;
    }
    
    .auth-link:hover {
      text-decoration: underline;
    }
    
    .message-container {
      margin-bottom: 20px;
      width: 100%;
      max-width: 430px;
    }
    
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .message.success {
      background-color: #D1FAE5;
      color: #065F46;
      border-left: 4px solid #10B981;
    }
    
    .message.error {
      background-color: #FEE2E2;
      color: #991B1B;
      border-left: 4px solid #EF4444;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Home Page Styles */
    .home-page {
      padding: 30px 0;
    }
    
    .welcome-card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .welcome-title {
      font-size: 28px;
      margin-bottom: 10px;
      color: var(--primary-color);
    }
    
    .welcome-subtitle {
      color: var(--gray-600);
      margin-bottom: 20px;
    }
    
    .action-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .action-card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      text-align: center;
    }
    
    .action-card i {
      font-size: 32px;
      color: var(--primary-color);
      margin-bottom: 15px;
    }
    
    .action-card h3 {
      margin-bottom: 10px;
      color: var(--gray-800);
    }
    
    .action-card p {
      color: var(--gray-600);
      margin-bottom: 15px;
    }
    
    .test-options {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .test-options h3 {
      margin-bottom: 15px;
      color: var(--gray-800);
    }
    
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }
    
    .option-group {
      margin-bottom: 15px;
    }
    
    .option-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 5px;
      color: var(--gray-700);
    }
    
    .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 14px;
      background-color: white;
    }
    
    /* Media Queries */
    @media (max-width: 768px) {
      .action-cards {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Auth Page (Login/Register) -->
    <div id="authPage" class="page auth-page">
      <div class="logo-container">
        <svg class="logo" width="177" height="60" viewBox="0 0 177 60" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M56.78 14.02L42.82 0.06C42.4 -0.02 41.92 -0.02 41.5 0.06L27.54 14.02C27.12 14.46 27.12 15.18 27.54 15.6L41.5 29.56C41.72 29.78 41.96 29.86 42.16 29.86C42.36 29.86 42.6 29.78 42.82 29.56L56.78 15.6C57.22 15.18 57.22 14.46 56.78 14.02Z" fill="#0056A4"/>
          <path d="M72.38 15.3H85.5C92.42 15.3 97.58 20.22 97.58 27.02C97.58 33.82 92.42 38.74 85.5 38.74H72.38V15.3ZM82.02 31.9H85.1C87.54 31.9 88.7 29.8 88.7 27.02C88.7 24.24 87.54 22.14 85.1 22.14H82.02V31.9Z" fill="#0056A4"/>
          <path d="M101.44 15.3H122.24V22.14H110.96V23.5H120.48V29.78H110.96V31.9H122.52V38.74H101.44V15.3Z" fill="#0056A4"/>
          <path d="M136.5 15.3C143.56 15.3 149.08 20.34 149.08 27C149.08 33.66 143.56 38.7 136.5 38.7C129.44 38.7 123.92 33.66 123.92 27C123.92 20.34 129.44 15.3 136.5 15.3ZM136.5 31.78C139.24 31.78 140.28 29.76 140.28 27C140.28 24.24 139.24 22.22 136.5 22.22C133.76 22.22 132.72 24.24 132.72 27C132.72 29.76 133.76 31.78 136.5 31.78Z" fill="#0056A4"/>
          <path d="M151.98 15.3H162.46L168.54 27.1H168.7V15.3H177V38.74H166.92L160.44 26.1H160.28V38.74H151.98V15.3Z" fill="#0056A4"/>
        </svg>
      </div>
      
      <div id="messageContainer" class="message-container"></div>
      
      <div class="auth-container">
        <h1 id="authTitle" class="auth-title">Sign In</h1>
        
        <div class="form-group" id="nameGroup" style="display: none;">
          <label for="name">Full Name</label>
          <div class="input-group">
            <i class="fas fa-user input-icon"></i>
            <input type="text" id="name" class="form-input" placeholder="John Doe">
          </div>
          <div id="nameError" class="error-message"></div>
        </div>
        
        <div class="form-group">
          <label for="email">Email Address</label>
          <div class="input-group">
            <i class="fas fa-envelope input-icon"></i>
            <input type="email" id="email" class="form-input" placeholder="you@example.com">
          </div>
          <div id="emailError" class="error-message"></div>
        </div>
        
        <div class="form-group">
          <label for="password">Password</label>
          <div class="input-group">
            <i class="fas fa-lock input-icon"></i>
            <input type="password" id="password" class="form-input" placeholder="••••••••">
          </div>
          <div id="passwordError" class="error-message"></div>
        </div>
        
        <div class="remember-forgot">
          <label class="remember-me">
            <input type="checkbox" id="rememberMe">
            <span>Remember me</span>
          </label>
          <a href="#" class="forgot-password">Forgot password?</a>
        </div>
        
        <button id="authButton" class="btn btn-primary">Sign In</button>
        
        <div class="divider">
          <div class="divider-line"></div>
          <div class="divider-text">OR</div>
          <div class="divider-line"></div>
        </div>
        
        <button id="googleAuthButton" class="btn btn-outline">
          <svg width="18" height="18" viewBox="0 0 24 24">
            <g transform="matrix(1, 0, 0, 1, 27.009001, -39.238998)">
              <path fill="#4285F4" d="M -3.264 51.509 C -3.264 50.719 -3.334 49.969 -3.454 49.239 L -14.754 49.239 L -14.754 53.749 L -8.284 53.749 C -8.574 55.229 -9.424 56.479 -10.684 57.329 L -10.684 60.329 L -6.824 60.329 C -4.564 58.239 -3.264 55.159 -3.264 51.509 Z" />
              <path fill="#34A853" d="M -14.754 63.239 C -11.514 63.239 -8.804 62.159 -6.824 60.329 L -10.684 57.329 C -11.764 58.049 -13.134 58.489 -14.754 58.489 C -17.884 58.489 -20.534 56.379 -21.484 53.529 L -25.464 53.529 L -25.464 56.619 C -23.494 60.539 -19.444 63.239 -14.754 63.239 Z" />
              <path fill="#FBBC05" d="M -21.484 53.529 C -21.734 52.809 -21.864 52.039 -21.864 51.239 C -21.864 50.439 -21.724 49.669 -21.484 48.949 L -21.484 45.859 L -25.464 45.859 C -26.284 47.479 -26.754 49.299 -26.754 51.239 C -26.754 53.179 -26.284 54.999 -25.464 56.619 L -21.484 53.529 Z" />
              <path fill="#EA4335" d="M -14.754 43.989 C -12.984 43.989 -11.404 44.599 -10.154 45.789 L -6.734 42.369 C -8.804 40.429 -11.514 39.239 -14.754 39.239 C -19.444 39.239 -23.494 41.939 -25.464 45.859 L -21.484 48.949 C -20.534 46.099 -17.884 43.989 -14.754 43.989 Z" />
            </g>
          </svg>
          Sign in with Google
        </button>
      </div>
      
      <div class="auth-footer">
        <span id="toggleText">Don't have an account?</span>
        <a href="#" id="toggleLink" class="auth-link">Sign Up</a>
      </div>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="page home-page">
      <div class="welcome-card">
        <h1 id="welcomeMessage" class="welcome-title">Hello!</h1>
        <p class="welcome-subtitle">Welcome back to the DECA Learning Platform. Ready to continue your journey?</p>
        <button id="logoutButton" class="btn btn-primary" style="max-width: 200px;">
          <i class="fas fa-sign-out-alt"></i> Log Out
        </button>
      </div>
      
      <div class="action-cards">
        <div class="action-card">
          <i class="fas fa-play-circle"></i>
          <h3>Start a Test</h3>
          <p>Take a new assessment to test your knowledge and skills</p>
          <button id="startTestButton" class="btn btn-primary">Start Test</button>
        </div>
        
        <div class="action-card">
          <i class="fas fa-chart-line"></i>
          <h3>View Performance</h3>
          <p>See your test history and track your progress over time</p>
          <button id="summaryButton" class="btn btn-primary">View Summary</button>
        </div>
        
        <div class="action-card">
          <i class="fas fa-hourglass-half"></i>
          <h3>Resume Test</h3>
          <p>Continue a previously started test session</p>
          <button id="resumeTestsButton" class="btn btn-primary">Resume Tests</button>
        </div>
      </div>
      
      <div class="test-options">
        <h3>Test Options</h3>
        <div class="options-grid">
          <div class="option-group">
            <label for="testSelect">Select Test Type</label>
            <select id="testSelect" class="form-select">
              <option value="" disabled selected>Choose a test</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          
          <div class="option-group">
            <label for="timeLimit">Time Limit (minutes)</label>
            <select id="timeLimit" class="form-select">
              <option value="0">No time limit</option>
              <option value="10">10 minutes</option>
              <option value="20">20 minutes</option>
              <option value="30" selected>30 minutes</option>
              <option value="45">45 minutes</option>
              <option value="60">60 minutes</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Other pages from the existing code would go here -->
    <div id="summaryPage" class="page">
      <!-- Summary page content -->
    </div>
    
    <div id="resumeTestsPage" class="page">
      <!-- Resume Tests page content -->
    </div>
    
    <div id="testPage" class="page">
      <!-- Test page content -->
    </div>
    
    <div id="resultsPage" class="page">
      <!-- Results page content -->
    </div>
    
    <div id="reviewPage" class="page">
      <!-- Review page content -->
    </div>
    
    <div id="testDetailPage" class="page">
      <!-- Test Detail page content -->
    </div>
    
    <div id="adminPage" class="page">
      <!-- Admin page content -->
    </div>
    
    <div id="userDetailPage" class="page">
      <!-- User Detail page content -->
    </div>
    
    <div id="adminVerificationPage" class="page">
      <!-- Admin Verification page content -->
    </div>

    <!-- Email Verification Page will be added dynamically -->
  </div>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAEJU8ZOlOuQzMNw7Cza-U_SuegJH29jRo",
      authDomain: "DECA-55fc4.firebaseapp.com",
      databaseURL: "https://DECA-55fc4-default-rtdb.firebaseio.com",
      projectId: "DECA-55fc4",
      storageBucket: "DECA-55fc4.appspot.com",
      messagingSenderId: "368623997898",
      appId: "1:368623997898:web:79b9952ee9e9fa0edb7533",
      measurementId: "G-7ZT1H2WTWH"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Page references - Same as provided code
    const pages = {
      auth: document.getElementById('authPage'),
      home: document.getElementById('homePage'),
      summary: document.getElementById('summaryPage'),
      resumeTests: document.getElementById('resumeTestsPage'),
      test: document.getElementById('testPage'),
      results: document.getElementById('resultsPage'),
      review: document.getElementById('reviewPage'),
      testDetail: document.getElementById('testDetailPage'),
      admin: document.getElementById('adminPage'),
      userDetail: document.getElementById('userDetailPage'),
      adminVerification: document.getElementById('adminVerificationPage'),
      emailVerification: null // Will be set during initialization
    };

    // Auth elements - Updated for new UI
    const authElements = {
      title: document.getElementById('authTitle'),
      button: document.getElementById('authButton'),
      toggleText: document.getElementById('toggleText'),
      toggleLink: document.getElementById('toggleLink'),
      nameGroup: document.getElementById('nameGroup'),
      messageContainer: document.getElementById('messageContainer'),
      googleButton: document.getElementById('googleAuthButton')
    };

    // Home elements - Same as provided code
    const homeElements = {
      welcomeMessage: document.getElementById('welcomeMessage'),
      logoutButton: document.getElementById('logoutButton'),
      startTestButton: document.getElementById('startTestButton'),
      summaryButton: document.getElementById('summaryButton'),
      resumeTestsButton: document.getElementById('resumeTestsButton'),
      timeLimit: document.getElementById('timeLimit'),
      adminButton: document.createElement('button') // Will add this dynamically if admin
    };

    // Form inputs - Same as provided code
    const formInputs = {
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      name: document.getElementById('name')
    };

    // Error message elements
    const errorElements = {
      email: document.getElementById('emailError'),
      password: document.getElementById('passwordError'),
      name: document.getElementById('nameError')
    };

    const testSelect = document.getElementById('testSelect');
    const loadingOverlay = document.getElementById('loadingOverlay');

    let appState = {
      isLoginMode: true,
      currentUser: null,
      testQuestions: [],
      currentQuestionIndex: 0,
      userAnswers: [],
      testData: null,
      timerInterval: null,
      timeRemaining: 0,
      completedTests: [],
      inProgressTests: {},
      testTypes: [],
      currentTestDetail: null,
      isAdmin: false,
      allUsers: [],
      currentUserDetail: null,
      adminEmail: "gautham0913@gmail.com", // Replace with your email
      adminVerificationCode: null,
      adminVerified: false,
      pendingVerification: null,
      emailVerificationElements: null
    };

    // Initialize email verification system
    function setupEmailVerification() {
      // Create email verification page (same as in the provided code)
      const verificationPage = document.createElement('div');
      verificationPage.id = 'emailVerificationPage';
      verificationPage.className = 'page auth-page';
      verificationPage.style.display = 'none';
      
      verificationPage.innerHTML = `
        <div class="logo-container">
          <svg class="logo" width="177" height="60" viewBox="0 0 177 60" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M56.78 14.02L42.82 0.06C42.4 -0.02 41.92 -0.02 41.5 0.06L27.54 14.02C27.12 14.46 27.12 15.18 27.54 15.6L41.5 29.56C41.72 29.78 41.96 29.86 42.16 29.86C42.36 29.86 42.6 29.78 42.82 29.56L56.78 15.6C57.22 15.18 57.22 14.46 56.78 14.02Z" fill="#0056A4"/>
            <path d="M72.38 15.3H85.5C92.42 15.3 97.58 20.22 97.58 27.02C97.58 33.82 92.42 38.74 85.5 38.74H72.38V15.3ZM82.02 31.9H85.1C87.54 31.9 88.7 29.8 88.7 27.02C88.7 24.24 87.54 22.14 85.1 22.14H82.02V31.9Z" fill="#0056A4"/>
            <path d="M101.44 15.3H122.24V22.14H110.96V23.5H120.48V29.78H110.96V31.9H122.52V38.74H101.44V15.3Z" fill="#0056A4"/>
            <path d="M136.5 15.3C143.56 15.3 149.08 20.34 149.08 27C149.08 33.66 143.56 38.7 136.5 38.7C129.44 38.7 123.92 33.66 123.92 27C123.92 20.34 129.44 15.3 136.5 15.3ZM136.5 31.78C139.24 31.78 140.28 29.76 140.28 27C140.28 24.24 139.24 22.22 136.5 22.22C133.76 22.22 132.72 24.24 132.72 27C132.72 29.76 133.76 31.78 136.5 31.78Z" fill="#0056A4"/>
            <path d="M151.98 15.3H162.46L168.54 27.1H168.7V15.3H177V38.74H166.92L160.44 26.1H160.28V38.74H151.98V15.3Z" fill="#0056A4"/>
          </svg>
        </div>
        
        <h1>Email Verification</h1>
        <div id="emailVerificationMessageContainer" class="message-container"></div>
        
        <div class="auth-container">
          <p class="welcome-message">A verification code has been sent to your email. Please verify your email to continue.</p>
          
          <div id="emailVerificationInfo" class="form-group">
            <p>We've sent a verification link to: <strong id="userEmailDisplay"></strong></p>
          </div>
          
          <button id="verifyEmailButton" class="btn btn-primary">
            <i class="fas fa-check-circle"></i> I've Verified My Email
          </button>
          
          <button id="resendVerificationButton" class="btn btn-outline" style="margin-top: 10px;">
            <i class="fas fa-redo"></i> Resend Verification Email
          </button>
          
          <button id="backToLoginButton" class="btn btn-outline" style="margin-top: 10px;">
            <i class="fas fa-times"></i> Back to Login
          </button>
        </div>
      `;
      
      // Add to container
      document.querySelector('.container').appendChild(verificationPage);
      
      // Add to pages object
      pages.emailVerification = verificationPage;
      
      // Store elements
      const emailVerificationElements = {
        page: verificationPage,
        messageContainer: document.getElementById('emailVerificationMessageContainer'),
        emailDisplay: document.getElementById('userEmailDisplay'),
        verifyButton: document.getElementById('verifyEmailButton'),
        resendButton: document.getElementById('resendVerificationButton'),
        backButton: document.getElementById('backToLoginButton')
      };
      
      // Add event listeners
      emailVerificationElements.verifyButton.addEventListener('click', checkEmailVerification);
      emailVerificationElements.resendButton.addEventListener('click', resendVerificationEmail);
      emailVerificationElements.backButton.addEventListener('click', () => showAuthPage());
      
      return emailVerificationElements;
    }

    // Create Admin Verification Page
    function setupAdminVerification() {
      const adminVerificationPage = pages.adminVerification;
      
      adminVerificationPage.innerHTML = `
        <div class="auth-page">
          <div class="logo-container">
            <svg class="logo" width="177" height="60" viewBox="0 0 177 60" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M56.78 14.02L42.82 0.06C42.4 -0.02 41.92 -0.02 41.5 0.06L27.54 14.02C27.12 14.46 27.12 15.18 27.54 15.6L41.5 29.56C41.72 29.78 41.96 29.86 42.16 29.86C42.36 29.86 42.6 29.78 42.82 29.56L56.78 15.6C57.22 15.18 57.22 14.46 56.78 14.02Z" fill="#0056A4"/>
              <path d="M72.38 15.3H85.5C92.42 15.3 97.58 20.22 97.58 27.02C97.58 33.82 92.42 38.74 85.5 38.74H72.38V15.3ZM82.02 31.9H85.1C87.54 31.9 88.7 29.8 88.7 27.02C88.7 24.24 87.54 22.14 85.1 22.14H82.02V31.9Z" fill="#0056A4"/>
              <path d="M101.44 15.3H122.24V22.14H110.96V23.5H120.48V29.78H110.96V31.9H122.52V38.74H101.44V15.3Z" fill="#0056A4"/>
              <path d="M136.5 15.3C143.56 15.3 149.08 20.34 149.08 27C149.08 33.66 143.56 38.7 136.5 38.7C129.44 38.7 123.92 33.66 123.92 27C123.92 20.34 129.44 15.3 136.5 15.3ZM136.5 31.78C139.24 31.78 140.28 29.76 140.28 27C140.28 24.24 139.24 22.22 136.5 22.22C133.76 22.22 132.72 24.24 132.72 27C132.72 29.76 133.76 31.78 136.5 31.78Z" fill="#0056A4"/>
              <path d="M151.98 15.3H162.46L168.54 27.1H168.7V15.3H177V38.74H166.92L160.44 26.1H160.28V38.74H151.98V15.3Z" fill="#0056A4"/>
            </svg>
          </div>
          
          <h1>Admin Verification</h1>
          <div id="verificationMessageContainer" class="message-container"></div>
          
          <div class="auth-container">
            <p class="welcome-message">Please enter the verification code sent to your email to access the admin dashboard.</p>
            
            <div class="form-group">
              <label for="verificationCode">Verification Code</label>
              <div class="input-group">
                <i class="fas fa-key input-icon"></i>
                <input type="text" id="verificationCode" class="form-input" placeholder="Enter your 6-digit code">
              </div>
            </div>
            
            <button id="verifyButton" class="btn btn-primary">
              <i class="fas fa-check-circle"></i> Verify Code
            </button>
            
            <button id="resendCodeButton" class="btn btn-outline" style="margin-top: 10px;">
              <i class="fas fa-redo"></i> Resend Code
            </button>
            
            <button id="cancelVerificationButton" class="btn btn-outline" style="margin-top: 10px;">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </div>
      `;
      
      // Admin Verification elements
      return {
        messageContainer: document.getElementById('verificationMessageContainer'),
        codeInput: document.getElementById('verificationCode'),
        verifyButton: document.getElementById('verifyButton'),
        resendButton: document.getElementById('resendCodeButton'),
        cancelButton: document.getElementById('cancelVerificationButton')
      };
    }

    // Validation functions for the login form
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function validatePassword(password) {
      return password.length >= 6;
    }

    function validateName(name) {
      return name.trim().length > 0;
    }

    function validateLoginForm() {
      let isValid = true;
      
      // Clear previous error messages
      errorElements.email.textContent = '';
      errorElements.password.textContent = '';
      errorElements.name.textContent = '';
      
      // Validate email
      if (!formInputs.email.value) {
        errorElements.email.textContent = 'Email is required';
        isValid = false;
      } else if (!validateEmail(formInputs.email.value)) {
        errorElements.email.textContent = 'Please enter a valid email';
        isValid = false;
      }
      
      // Validate password
      if (!formInputs.password.value) {
        errorElements.password.textContent = 'Password is required';
        isValid = false;
      } else if (!validatePassword(formInputs.password.value)) {
        errorElements.password.textContent = 'Password must be at least 6 characters';
        isValid = false;
      }
      
      // Validate name if in signup mode
      if (!appState.isLoginMode) {
        if (!formInputs.name.value) {
          errorElements.name.textContent = 'Name is required';
          isValid = false;
        } else if (!validateName(formInputs.name.value)) {
          errorElements.name.textContent = 'Please enter a valid name';
          isValid = false;
        }
      }
      
      return isValid;
    }

    // Modified Sign In function with validation
    async function handleSignIn() {
      if (!validateLoginForm()) return;
      
      const email = formInputs.email.value.trim();
      const password = formInputs.password.value.trim();
      
      toggleLoading(true);
      
      try {
        // Sign in
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Get user data
        const userSnapshot = await database.ref('users/' + user.uid).once('value');
        const userData = userSnapshot.val();
        
        // Check if email is verified
        const verificationSnapshot = await database.ref(`userVerifications/${user.uid}`).once('value');
        const verificationData = verificationSnapshot.val();
        
        if (userData.emailVerified !== true && (!verificationData || verificationData.verified !== true)) {
          // Email not verified
          showMessage('Please verify your email before signing in.', 'error');
          
          // Set pending verification
          appState.pendingVerification = { user, email, name: userData.name };
          
          // Show verification page
          setTimeout(() => {
            showEmailVerificationPage(user, email, userData.name);
            toggleLoading(false);
          }, 1000);
          return;
        }
        
        // Email is verified, proceed with login
        await database.ref('users/' + user.uid + '/lastLogin').set(new Date().toString());
        showMessage('Login successful!', 'success');
        
        appState.currentUser = { uid: user.uid, name: userData.name, email: userData.email };
        appState.isAdmin = (userData.email === appState.adminEmail);
        
        setTimeout(() => {
          showHomePage(userData.name);
          toggleLoading(false);
        }, 1000);
      } catch (err) {
        showMessage(err.message, 'error');
        toggleLoading(false);
      }
    }

    // Modified Sign Up function with validation
    async function handleSignUp() {
      if (!validateLoginForm()) return;
      
      const email = formInputs.email.value.trim();
      const password = formInputs.password.value.trim();
      const name = formInputs.name.value.trim();
      
      toggleLoading(true);
      
      try {
        // Create user account
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Generate verification token
        const verificationToken = generateVerificationToken();
        
        // Create initial user data
        await database.ref('users/' + user.uid).set({
          email, 
          name, 
          lastLogin: new Date().toString(),
          emailVerified: false,
          tests: {}
        });
        
        // Send verification email
        const emailSent = await sendVerificationEmail(user, email, verificationToken);
        
        if (emailSent) {
          showMessage('Account created! Please verify your email to continue.', 'success');
          
          // Show verification page
          setTimeout(() => {
            showEmailVerificationPage(user, email, name);
            toggleLoading(false);
          }, 1000);
        } else {
          showMessage('Account created, but failed to send verification email. Please try again.', 'error');
          toggleLoading(false);
        }
      } catch (err) {
        showMessage(err.message, 'error');
        toggleLoading(false);
      }
    }

    // Add Google Sign-In functionality
    async function handleGoogleSignIn() {
      toggleLoading(true);
      
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        
        // The signed-in user info
        const user = result.user;
        
        // Check if this is a new or existing user
        const userSnapshot = await database.ref('users/' + user.uid).once('value');
        const userData = userSnapshot.val();
        
        if (!userData) {
          // New user - create user data
          await database.ref('users/' + user.uid).set({
            email: user.email,
            name: user.displayName || 'Google User',
            lastLogin: new Date().toString(),
            emailVerified: true, // Google accounts are pre-verified
            tests: {}
          });
          
          showMessage('Account created successfully!', 'success');
        } else {
          // Existing user - update last login
          await database.ref('users/' + user.uid + '/lastLogin').set(new Date().toString());
          showMessage('Login successful!', 'success');
        }
        
        // Set appState
        appState.currentUser = { 
          uid: user.uid, 
          name: userData ? userData.name : (user.displayName || 'Google User'), 
          email: user.email 
        };
        
        // Check if admin
        appState.isAdmin = (user.email === appState.adminEmail);
        
        // Show home page
        setTimeout(() => {
          showHomePage(appState.currentUser.name);
          toggleLoading(false);
        }, 1000);
      } catch (err) {
        console.error('Error during Google sign in:', err);
        showMessage(err.message, 'error');
        toggleLoading(false);
      }
    }

    // Generate a secure verification token
    function generateVerificationToken() {
      const array = new Uint8Array(32);
      window.crypto.getRandomValues(array);
      return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
    }

    // Send verification email
    async function sendVerificationEmail(user, email, token) {
      try {
        toggleLoading(true);
        
        // Create user verification data in database
        await database.ref(`userVerifications/${user.uid}`).set({
          email: email,
          token: token,
          createdAt: new Date().toString(),
          verified: false
        });
        
        // In a real app, this would send an actual email with the code
        // For now, we'll just show it in a message for demo purposes
        
        console.log('Verification token:', token);
        
        // Example verification URL (this would be included in the email)
        const verificationUrl = `${window.location.origin}${window.location.pathname}?mode=verifyEmail&oobCode=${token}&uid=${user.uid}`;
        console.log('Verification URL:', verificationUrl);
        
        // Show alert with the verification URL (for demo purposes only)
        alert(`For demo purposes: Your verification URL is: ${verificationUrl}\n\nIn a real implementation, this would be sent to your email.`);
        
        showVerificationMessage('Verification email sent! Please check your inbox and spam folder.', 'success');
        toggleLoading(false);
        
        return true;
      } catch (error) {
        console.error('Error sending verification email:', error);
        showVerificationMessage('Failed to send verification email. Please try again.', 'error');
        toggleLoading(false);
        return false;
      }
    }

    // Check if email is verified
    async function checkEmailVerification() {
      if (!appState.pendingVerification || !appState.pendingVerification.user) {
        showVerificationMessage('No pending verification found. Please try signing up again.', 'error');
        return;
      }
      
      try {
        toggleLoading(true);
        
        const user = appState.pendingVerification.user;
        
        // Reload user to get latest verification status
        await user.reload();
        
        // Check database verification status
        const verificationSnapshot = await database.ref(`userVerifications/${user.uid}`).once('value');
        const verificationData = verificationSnapshot.val();
        
        if (verificationData && verificationData.verified === true) {
          // Email is verified, complete the sign-up process
          showVerificationMessage('Email verified successfully!', 'success');
          
          // Update user status
          await database.ref(`users/${user.uid}`).update({
            emailVerified: true
          });
          
          // Complete registration and proceed to home page
          appState.currentUser = {
            uid: user.uid,
            name: appState.pendingVerification.name,
            email: appState.pendingVerification.email
          };
          
          setTimeout(() => {
            showHomePage(appState.pendingVerification.name);
            toggleLoading(false);
          }, 1000);
        } else {
          // Email not verified yet
          showVerificationMessage('Email not verified yet. Please check your inbox and click the verification link.', 'error');
          toggleLoading(false);
        }
      } catch (error) {
        console.error('Error checking email verification:', error);
        showVerificationMessage('Failed to check verification status. Please try again.', 'error');
        toggleLoading(false);
      }
    }

    // Process email verification from URL
    async function processEmailVerification() {
      // Extract verification parameters from URL
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode');
      const oobCode = urlParams.get('oobCode');
      const uid = urlParams.get('uid');
      
      if (mode === 'verifyEmail' && oobCode && uid) {
        try {
          toggleLoading(true);
          
          // Check if token matches
          const verificationSnapshot = await database.ref(`userVerifications/${uid}`).once('value');
          const verificationData = verificationSnapshot.val();
          
          if (verificationData && verificationData.token === oobCode) {
            // Verify the email
            await database.ref(`userVerifications/${uid}`).update({
              verified: true,
              verifiedAt: new Date().toString()
            });
            
            // Update user status
            await database.ref(`users/${uid}`).update({
              emailVerified: true
            });
            
            // Show success message
            alert('Email verified successfully! You can now sign in to your account.');
          } else {
            alert('Invalid or expired verification link. Please try again or request a new verification email.');
          }
          
          // Clear URL parameters
          window.history.replaceState({}, document.title, window.location.pathname);
          
          // Redirect to login page
          showAuthPage();
          toggleLoading(false);
        } catch (error) {
          console.error('Error verifying email:', error);
          alert('Error verifying email. Please try again.');
          toggleLoading(false);
        }
      }
    }

    // Resend verification email
    async function resendVerificationEmail() {
      if (!appState.pendingVerification || !appState.pendingVerification.user) {
        showVerificationMessage('No pending verification found. Please try signing up again.', 'error');
        return;
      }
      
      try {
        toggleLoading(true);
        
        const user = appState.pendingVerification.user;
        const email = appState.pendingVerification.email;
        const newToken = generateVerificationToken();
        
        // Update token in database
        await database.ref(`userVerifications/${user.uid}`).update({
          token: newToken,
          createdAt: new Date().toString()
        });
        
        // In a real implementation, you would send an actual email here
        
        console.log('New verification token:', newToken);
        
        // Example verification URL (this would be included in the email)
        const verificationUrl = `${window.location.origin}${window.location.pathname}?mode=verifyEmail&oobCode=${newToken}&uid=${user.uid}`;
        console.log('Verification URL:', verificationUrl);
        
        // Show alert with the verification URL (for demo purposes only)
        alert(`For demo purposes: Your new verification URL is: ${verificationUrl}\n\nIn a real implementation, this would be sent to your email.`);
        
        showVerificationMessage('Verification email resent! Please check your inbox and spam folder.', 'success');
        toggleLoading(false);
      } catch (error) {
        console.error('Error resending verification email:', error);
        showVerificationMessage('Failed to resend verification email. Please try again.', 'error');
        toggleLoading(false);
      }
    }

    // Show email verification page
    function showEmailVerificationPage(user, email, name) {
      // Set pending verification state
      appState.pendingVerification = { user, email, name };
      
      // Update email display
      document.getElementById('userEmailDisplay').textContent = email;
      
      // Show verification page
      showPage(pages.emailVerification);
    }

    // Show verification message
    function showVerificationMessage(msg, type) {
      if (!appState.emailVerificationElements) return;
      
      const container = appState.emailVerificationElements.messageContainer;
      container.innerHTML = `<div class="message ${type}">${msg}</div>`;
    }
    
    // Clear verification message
    function clearVerificationMessage() {
      if (!appState.emailVerificationElements) return;
      
      const container = appState.emailVerificationElements.messageContainer;
      container.innerHTML = '';
    }

    function showMessage(msg, type) {
      authElements.messageContainer.innerHTML = `<div class="message ${type}">${msg}</div>`;
    }

    function clearMessage() {
      authElements.messageContainer.innerHTML = '';
    }

    function toggleLoading(show) {
      loadingOverlay.style.display = show ? 'flex' : 'none';
    }

    // Page navigation functions
    function showPage(p) {
      Object.values(pages).forEach(pg => {
        if (pg) pg.style.display = 'none';
      });
      p.style.display = 'block';
    }

    function showHomePage(name) {
      showPage(pages.home);
      homeElements.startTestButton.disabled = false;
      formInputs.email.value = '';
      formInputs.password.value = '';
      formInputs.name.value = '';
      homeElements.welcomeMessage.textContent = `Hello, ${name}!`;
      
      // Check if user is admin and add admin button if needed
      if (appState.isAdmin) {
        if (!document.getElementById('adminButton')) {
          const adminBtn = homeElements.adminButton;
          adminBtn.id = 'adminButton';
          adminBtn.className = 'btn btn-primary';
          adminBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Admin Dashboard';
          adminBtn.style.marginTop = '1rem';
          adminBtn.addEventListener('click', () => {
            showAdminVerificationPage();
          });
          
          // Add to DOM after logout button
          homeElements.logoutButton.parentNode.insertBefore(adminBtn, homeElements.logoutButton);
        }
      }
    }

    function showAuthPage() {
      showPage(pages.auth);
      appState.isLoginMode = true;
      authElements.title.textContent = 'Sign In';
      authElements.button.textContent = 'Sign In';
      authElements.toggleText.textContent = "Don't have an account?";
      authElements.toggleLink.textContent = 'Sign Up';
      authElements.nameGroup.style.display = 'none';
    }

    // Show admin verification page
    function showAdminVerificationPage() {
      // Reset state
      appState.adminVerified = false;
      verificationElements.codeInput.value = '';
      clearAdminVerificationMessage();
      
      // Send initial verification code
      sendVerificationCode();
      
      // Show verification page
      showPage(pages.adminVerification);
    }

    function clearAdminVerificationMessage() {
      verificationElements.messageContainer.innerHTML = '';
    }

    function showAdminVerificationMessage(msg, type) {
      verificationElements.messageContainer.innerHTML = `<div class="message ${type}">${msg}</div>`;
    }

    // Generate verification code
    function generateVerificationCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Send verification code (simulated)
    function sendVerificationCode() {
      // Generate a new 6-digit code
      appState.adminVerificationCode = generateVerificationCode();
      
      // In a real app, this would send an email with the code
      // For now, we'll just show it in a message for demo purposes
      showAdminVerificationMessage(`Verification code sent! (For demo purposes, your code is: ${appState.adminVerificationCode})`, 'success');
      
      console.log('Verification code:', appState.adminVerificationCode);
    }

    // Verify admin code
    function verifyAdminCode() {
      const enteredCode = verificationElements.codeInput.value.trim();
      
      if (!enteredCode) {
        showAdminVerificationMessage('Please enter the verification code.', 'error');
        return;
      }
      
      if (enteredCode !== appState.adminVerificationCode) {
        showAdminVerificationMessage('Invalid verification code. Please try again.', 'error');
        return;
      }
      
      // Code is valid, mark as verified and proceed to admin dashboard
      appState.adminVerified = true;
      showAdminPage();
    }

    // Admin page functions
    async function showAdminPage() {
      // Check if admin is verified
      if (!appState.isAdmin) {
        alert('You do not have permission to access the admin dashboard.');
        showHomePage(appState.currentUser.name);
        return;
      }
      
      if (!appState.adminVerified) {
        showAdminVerificationPage();
        return;
      }
      
      toggleLoading(true);
      
      try {
        // Load all users
        await loadAllUsers();
        
        // Create admin charts
        createAdminCharts();
        
        // Render users list
        renderUsersList();
        
        // Set welcome message
        adminElements.welcomeMessage.textContent = `Hello, ${appState.currentUser.name}!`;
        
        // Show admin page
        showPage(pages.admin);
      } catch (err) {
        console.error('Error loading admin page:', err);
        alert('Error loading admin dashboard. Please try again.');
      } finally {
        toggleLoading(false);
      }
    }

    // Load all users - stub function, would be implemented in full code
    async function loadAllUsers() {
      appState.allUsers = [];
      // Implementation from original code would go here
    }

    // Create admin charts - stub function, would be implemented in full code
    function createAdminCharts() {
      // Implementation from original code would go here
    }

    // Render users list - stub function, would be implemented in full code
    function renderUsersList() {
      // Implementation from original code would go here
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize email verification system
      appState.emailVerificationElements = setupEmailVerification();
      
      // Set up admin verification elements
      verificationElements = setupAdminVerification();
      
      // Add event listeners for verification elements
      verificationElements.verifyButton.addEventListener('click', verifyAdminCode);
      verificationElements.resendButton.addEventListener('click', sendVerificationCode);
      verificationElements.cancelButton.addEventListener('click', () => {
        showHomePage(appState.currentUser.name);
      });
      
      // Allow pressing Enter to submit verification code
      verificationElements.codeInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
          verifyAdminCode();
        }
      });
      
      // Check for verification links in URL
      processEmailVerification();
      
      // Toggle auth form
      authElements.toggleLink.addEventListener('click', () => {
        appState.isLoginMode = !appState.isLoginMode;
        if (appState.isLoginMode) {
          authElements.title.textContent = 'Sign In';
          authElements.button.textContent = 'Sign In';
          authElements.toggleText.textContent = "Don't have an account?";
          authElements.toggleLink.textContent = 'Sign Up';
          authElements.nameGroup.style.display = 'none';
        } else {
          authElements.title.textContent = 'Sign Up';
          authElements.button.textContent = 'Sign Up';
          authElements.toggleText.textContent = 'Already have an account?';
          authElements.toggleLink.textContent = 'Sign In';
          authElements.nameGroup.style.display = 'block';
        }
        clearMessage();
      });
      
      // Sign In / Sign Up button
      authElements.button.addEventListener('click', () => {
        if (appState.isLoginMode) {
          handleSignIn();
        } else {
          handleSignUp();
        }
      });
      
      // Google Sign In button
      authElements.googleButton.addEventListener('click', handleGoogleSignIn);
      
      // Logout button
      homeElements.logoutButton.addEventListener('click', () => {
        auth.signOut().then(() => {
          appState.currentUser = null;
          appState.isAdmin = false;
          appState.adminVerified = false;
          showAuthPage();
        }).catch(error => {
          console.error('Error signing out:', error);
        });
      });
      
      // Load tests and check auth on page load
      try {
        // Check user auth state immediately
        auth.onAuthStateChanged(async (usr) => {
          if (usr) {
            toggleLoading(true);
            const snap = await database.ref('users/' + usr.uid).once('value');
            const data = snap.val();
            
            // Check if email is verified
            if (data.emailVerified !== true) {
              // Get verification status
              const verificationSnapshot = await database.ref(`userVerifications/${usr.uid}`).once('value');
              const verificationData = verificationSnapshot.val();
              
              if (!verificationData || verificationData.verified !== true) {
                // Show verification page
                appState.pendingVerification = { user: usr, email: data.email, name: data.name };
                showEmailVerificationPage(usr, data.email, data.name);
                toggleLoading(false);
                return;
              }
              
              // Update user verified status if needed
              await database.ref('users/' + usr.uid).update({ emailVerified: true });
            }
            
            appState.currentUser = { uid: usr.uid, name: data.name, email: data.email };
            
            // Check if this user is the admin
            appState.isAdmin = (data.email === appState.adminEmail);
            appState.adminVerified = false; // Reset verification state
            
            // Load user's completed tests
            // await loadCompletedTests();
            
            // Load user's in-progress tests
            // await loadInProgressTests();
            
            showHomePage(data.name);
            toggleLoading(false);
          } else {
            showAuthPage();
          }
        });
      } catch (err) {
        console.error('Error during authentication check:', err);
      }
    });
  </script>
</body>
</html>
