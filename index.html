<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DECA Finance Test Platform</title>
  <style>
    :root {
      --primary-color: #4285F4;
      --primary-dark: #3367D6;
      --danger-color: #F44336;
      --danger-dark: #D32F2F;
      --success-color: #4CAF50;
      --success-dark: #388E3C;
      --warning-color: #FFA000;
      --warning-dark: #FF8F00;
      --light-bg: #f5f5f5;
      --border-color: #ddd;
      --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin:0; padding:0;
      display:flex; justify-content:center; align-items:center;
      min-height:100vh; background-color:var(--light-bg);
    }
    .container {
      background:white; border-radius:8px; box-shadow:var(--box-shadow);
      padding:30px; width:90%; max-width:800px; transition:var(--transition);
    }
    .page { display:none; }
    .auth-page, .test-options { max-width:350px; margin:0 auto; }
    h1,h2 { text-align:center; color:#333; margin-bottom:20px; }
    .form-group { margin-bottom:20px; }
    label { display:block; margin-bottom:8px; font-weight:500; color:#555; }
    input, select {
      width:100%; padding:10px; border:1px solid var(--border-color);
      border-radius:4px; font-size:16px;
    }
    button {
      background:var(--primary-color); color:white; border:none;
      border-radius:4px; padding:12px 0; width:100%; font-size:16px;
      cursor:pointer; transition:var(--transition); margin-bottom:10px;
    }
    button:hover { background:var(--primary-dark); }
    button:disabled { background:#ccc; cursor:not-allowed; }
    .toggle-form { text-align:center; margin-top:20px; }
    .toggle-form a { color:var(--primary-color); text-decoration:none; }
    .toggle-form a:hover { text-decoration:underline; }
    .message { padding:10px; border-radius:4px; margin-bottom:20px; text-align:center; }
    .error { background:#FFEBEE; color:var(--danger-dark); }
    .success { background:#E8F5E9; color:var(--success-dark); }
    .message-container { min-height:60px; }
    .welcome-message { text-align:center; font-size:18px; margin-bottom:20px;}
    .logout-btn { background:var(--danger-color); }
    .logout-btn:hover { background:var(--danger-dark); }
    .test-options { background:#fff; border-radius:8px; box-shadow:var(--box-shadow); padding:30px; }
    .test-settings { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; }
    .action-btn { margin:5px 0; font-weight:bold; }
    .progress-container {
      width:100%; height:8px; background:#e0e0e0; border-radius:4px; margin-bottom:15px;
    }
    .progress-bar { height:100%; background:var(--primary-color); border-radius:4px; transition:width .3s; }
    @media (max-width:600px){
      .container { width:95%; padding:15px; }
      .test-settings { grid-template-columns:1fr; }
    }
    #loadingOverlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(255,255,255,.8); display:none; justify-content:center; align-items:center; z-index:1000;
    }
    .spinner {
      border:5px solid #f3f3f3; border-top:5px solid var(--primary-color);
      border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
  </style>
</head>
<body>
  <div id="loadingOverlay"><div class="spinner"></div></div>
  <div class="container">
    <!-- Auth Page -->
    <div id="authPage" class="page auth-page">
      <h1 id="authTitle">Sign In</h1>
      <div id="messageContainer" class="message-container"></div>
      <div class="form-group"><label for="email">Email</label><input type="email" id="email" placeholder="Enter your email"></div>
      <div class="form-group"><label for="password">Password</label><input type="password" id="password" placeholder="Enter your password"></div>
      <div id="nameGroup" class="form-group" style="display:none;">
        <label for="name">Full Name</label><input type="text" id="name" placeholder="Enter your full name">
      </div>
      <button id="authButton">Sign In</button>
      <div class="toggle-form">
        <p><span id="toggleText">Don't have an account?</span> <a id="toggleLink">Sign Up</a></p>
      </div>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="page">
      <h1>Welcome to DECA Finance Test</h1>
      <div id="welcomeMessage" class="welcome-message"></div>
      <div class="test-options">
        <h2>Test Options</h2>
        <div class="test-settings">
          <!-- New: Choose Test -->
          <div class="form-group">
            <label for="testSelect">Choose a Test</label>
            <select id="testSelect">
              <option value="" disabled selected>Loading tests…</option>
            </select>
          </div>
          <!-- You can keep time limit if desired -->
          <div class="form-group">
            <label for="timeLimit">Time Limit</label>
            <select id="timeLimit">
              <option value="0">No Time Limit</option>
              <option value="10">10 Minutes</option>
              <option value="20">20 Minutes</option>
              <option value="30">30 Minutes</option>
              <option value="45">45 Minutes</option>
              <option value="60" selected>60 Minutes</option>
              <option value="90">90 Minutes</option>
              <option value="120">2 Hours</option>
            </select>
          </div>
        </div>
        <div class="progress-container"><div id="testProgress" class="progress-bar" style="width:0%"></div></div>
        <button id="startTestButton" class="action-btn">Start New Test</button>
        <button id="resumeTestButton" class="action-btn" style="display:none;">Resume Test</button>
      </div>
      <button id="logoutButton" class="logout-btn">Logout</button>
    </div>

    <!-- Test Page -->
    <div id="testPage" class="page">
      <div class="test-header">
        <h1>DECA Finance Cluster Practice Test</h1>
        <div class="test-info">
          <span id="questionCounter">Question 1</span>
          <span id="timerDisplay">Time Remaining</span>
        </div>
      </div>
      <div class="progress-container"><div id="questionProgress" class="progress-bar" style="width:0%"></div></div>
      <div id="questionContainer" class="question-container">
        <h3 id="questionText"></h3>
        <div id="optionsContainer" class="options-container"></div>
      </div>
      <div class="test-navigation">
        <button id="prevButton" class="nav-btn">Previous</button>
        <button id="nextButton" class="nav-btn">Next</button>
        <button id="saveAndExitButton" class="exit-btn">Save & Exit</button>
        <button id="submitTestButton" class="submit-btn">Submit Test</button>
      </div>
    </div>

    <!-- Results Page -->
    <div id="resultsPage" class="page">
      <h1>Test Results</h1>
      <div class="results-summary">
        <h2>Summary</h2>
        <p>Score: <span id="scoreDisplay"></span></p>
        <p>Percentage: <span id="percentageDisplay"></span></p>
        <p>Time Taken: <span id="timeTakenDisplay"></span></p>
      </div>
      <div class="results-actions">
        <button id="reviewTestButton" class="action-btn">Review Answers</button>
        <button id="returnHomeButton" class="action-btn">Return to Home</button>
      </div>
    </div>

    <!-- Review Page -->
    <div id="reviewPage" class="page">
      <h1>Review Your Answers</h1>
      <div id="reviewContainer"></div>
      <button id="backToResultsButton" class="action-btn">Back to Results</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-auth-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-database-compat.min.js"></script>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAEJU8ZOlOuQzMNw7Cza-U_SuegJH29jRo",
      authDomain: "deca-55fc4.firebaseapp.com",
      databaseURL: "https://deca-55fc4-default-rtdb.firebaseio.com",
      projectId: "deca-55fc4",
      storageBucket: "deca-55fc4.appspot.com",
      messagingSenderId: "368623997898",
      appId: "1:368623997898:web:79b9952ee9e9fa0edb7533",
      measurementId: "G-7ZT1H2WTWH"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Page references
    const pages = {
      auth: document.getElementById('authPage'),
      home: document.getElementById('homePage'),
      test: document.getElementById('testPage'),
      results: document.getElementById('resultsPage'),
      review: document.getElementById('reviewPage')
    };
    // Auth elements
    const authElements = {
      title: document.getElementById('authTitle'),
      button: document.getElementById('authButton'),
      toggleText: document.getElementById('toggleText'),
      toggleLink: document.getElementById('toggleLink'),
      nameGroup: document.getElementById('nameGroup'),
      messageContainer: document.getElementById('messageContainer')
    };
    // Home elements
    const homeElements = {
      welcomeMessage: document.getElementById('welcomeMessage'),
      logoutButton: document.getElementById('logoutButton'),
      startTestButton: document.getElementById('startTestButton'),
      resumeTestButton: document.getElementById('resumeTestButton'),
      testProgress: document.getElementById('testProgress'),
      timeLimit: document.getElementById('timeLimit')
    };
    // Test elements
    const testElements = {
      questionCounter: document.getElementById('questionCounter'),
      timerDisplay: document.getElementById('timerDisplay'),
      questionText: document.getElementById('questionText'),
      optionsContainer: document.getElementById('optionsContainer'),
      prevButton: document.getElementById('prevButton'),
      nextButton: document.getElementById('nextButton'),
      saveAndExitButton: document.getElementById('saveAndExitButton'),
      submitTestButton: document.getElementById('submitTestButton'),
      questionProgress: document.getElementById('questionProgress')
    };
    // Results elements
    const resultsElements = {
      scoreDisplay: document.getElementById('scoreDisplay'),
      percentageDisplay: document.getElementById('percentageDisplay'),
      timeTakenDisplay: document.getElementById('timeTakenDisplay'),
      reviewTestButton: document.getElementById('reviewTestButton'),
      returnHomeButton: document.getElementById('returnHomeButton')
    };
    // Review elements
    const reviewElements = {
      container: document.getElementById('reviewContainer'),
      backButton: document.getElementById('backToResultsButton')
    };
    // Form inputs
    const formInputs = {
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      name: document.getElementById('name')
    };
    const testSelect = document.getElementById('testSelect');
    const loadingOverlay = document.getElementById('loadingOverlay');

    let appState = {
      isLoginMode: true,
      currentUser: null,
      testQuestions: [],
      currentQuestionIndex: 0,
      userAnswers: [],
      testData: null,
      timerInterval: null,
      timeRemaining: 0
    };

    function toggleLoading(show) {
      loadingOverlay.style.display = show ? 'flex' : 'none';
    }
    function showMessage(msg, type) {
      authElements.messageContainer.innerHTML =
        `<div class="message ${type}">${msg}</div>`;
    }
    function clearMessage() {
      authElements.messageContainer.innerHTML = '';
    }

    // Toggle auth form
    authElements.toggleLink.addEventListener('click', () => {
      appState.isLoginMode = !appState.isLoginMode;
      if (appState.isLoginMode) {
        authElements.title.textContent = 'Sign In';
        authElements.button.textContent = 'Sign In';
        authElements.toggleText.textContent = "Don't have an account?";
        authElements.toggleLink.textContent = 'Sign Up';
        authElements.nameGroup.style.display = 'none';
      } else {
        authElements.title.textContent = 'Sign Up';
        authElements.button.textContent = 'Sign Up';
        authElements.toggleText.textContent = 'Already have an account?';
        authElements.toggleLink.textContent = 'Sign In';
        authElements.nameGroup.style.display = 'block';
      }
      clearMessage();
    });

    // Sign In / Sign Up
    authElements.button.addEventListener('click', async () => {
      const email = formInputs.email.value.trim();
      const password = formInputs.password.value.trim();
      if (!email || !password) {
        showMessage('Please enter both email and password.', 'error');
        return;
      }
      toggleLoading(true);
      try {
        if (!appState.isLoginMode) {
          // Sign up
          const name = formInputs.name.value.trim();
          if (!name) {
            showMessage('Please enter your name.', 'error');
            toggleLoading(false);
            return;
          }
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;
          await database.ref('users/' + user.uid).set({
            email, name, lastLogin: new Date().toString(), tests: {}
          });
          showMessage('Account created successfully!', 'success');
          appState.currentUser = { uid: user.uid, name, email };
          setTimeout(() => {
            showHomePage(name);
            toggleLoading(false);
          }, 1000);
        } else {
          // Sign in
          const userCredential = await auth.signInWithEmailAndPassword(email, password);
          showMessage('Login successful!', 'success');
          const user = userCredential.user;
          const snap = await database.ref('users/' + user.uid).once('value');
          const userData = snap.val();
          await database.ref('users/' + user.uid + '/lastLogin').set(new Date().toString());
          appState.currentUser = { uid: user.uid, name: userData.name, email: userData.email };
          const hasInProgress = userData.tests && userData.tests.inProgress;
          homeElements.resumeTestButton.style.display = hasInProgress ? 'block' : 'none';
          setTimeout(() => {
            showHomePage(userData.name);
            toggleLoading(false);
          }, 1000);
        }
      } catch (err) {
        showMessage(err.message, 'error');
        toggleLoading(false);
      }
    });

    // Populate testSelect on load
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const snap = await database.ref('questions').once('value');
        const tests = snap.exists() ? Object.keys(snap.val()) : [];
        testSelect.innerHTML = '';
        tests.forEach(key => {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = key.replace(/-/g,' ').toUpperCase();
          testSelect.appendChild(opt);
        });
      } catch (err) {
        console.error('Error loading tests:', err);
        testSelect.innerHTML = '<option disabled>Error loading tests</option>';
      }
      // Also check user auth state immediately
      auth.onAuthStateChanged(async (usr) => {
        if (usr) {
          toggleLoading(true);
          const snap = await database.ref('users/' + usr.uid).once('value');
          const data = snap.val();
          appState.currentUser = { uid: usr.uid, name: data.name, email: data.email };
          const inProg = data.tests && data.tests.inProgress;
          homeElements.resumeTestButton.style.display = inProg ? 'block' : 'none';
          showHomePage(data.name);
          toggleLoading(false);
        } else {
          showAuthPage();
        }
      });
    });

    // Start New Test
    homeElements.startTestButton.addEventListener('click', async () => {
      const testKey = testSelect.value;
      if (!testKey) {
        alert('Please choose a test.');
        return;
      }
      toggleLoading(true);
      homeElements.startTestButton.disabled = true;
      try {
        // Load every question under that test
        const snap = await database.ref(`questions/${testKey}`).once('value');
        const data = snap.val();
        if (!data) throw new Error(`No questions for "${testKey}".`);
        const questions = Object.entries(data).map(([id,q]) => ({ id, ...q }));
        appState.testQuestions = questions;
        appState.userAnswers = Array(questions.length).fill(null);
        appState.currentQuestionIndex = 0;
        // Setup testData
        const timeLimitMin = parseInt(homeElements.timeLimit.value);
        appState.timeRemaining = timeLimitMin * 60;
        appState.testData = {
          startTime: new Date().toString(),
          answers: Array(questions.length).fill(null),
          completed: false,
          questions: questions.map(q=>q.id),
          questionCount: questions.length,
          timeLimit: timeLimitMin
        };
        await saveTestProgress();
        showTestPage();
      } catch (err) {
        console.error('Error loading test:', err);
        showMessage('Error: ' + err.message, 'error');
        homeElements.startTestButton.disabled = false;
      } finally {
        toggleLoading(false);
      }
    });

    // Resume Test (unchanged)
    homeElements.resumeTestButton.addEventListener('click', async()=>{
      toggleLoading(true);
      homeElements.resumeTestButton.disabled = true;
      try {
        const snap = await database.ref(`users/${appState.currentUser.uid}/tests/inProgress`).once('value');
        const saved = snap.val();
        if (!saved || !saved.questions) throw new Error('No in-progress test');
        const qs = await Promise.all(saved.questions.map(id=>
          database.ref(`questions/${saved.testKey}/${id}`).once('value').then(s=>s.val())
        ));
        const valid = qs.filter(q=>q!==null);
        appState.testQuestions = valid;
        appState.userAnswers = saved.answers || Array(valid.length).fill(null);
        appState.currentQuestionIndex = saved.lastQuestionIndex || 0;
        appState.testData = saved;
        // timeRemaining
        if (saved.timeLimit>0) {
          const elapsed = Math.floor((new Date()-new Date(saved.startTime))/1000);
          appState.timeRemaining = Math.max(0, saved.timeLimit*60 - elapsed);
        }
        showTestPage();
      } catch(err){
        console.error(err);
        alert('Could not resume, starting new.');
        homeElements.startTestButton.click();
      } finally {
        toggleLoading(false);
        homeElements.resumeTestButton.disabled = false;
      }
    });

    // Navigation, timer, displayQuestion, saveTestProgress, submit, review, etc...
    // (All of your existing handlers/callbacks remain unchanged from original code.)
    // Just make sure saveTestProgress stores saved.testKey = testSelect.value

    async function saveTestProgress(){
      if(!appState.currentUser||!appState.testData)return;
      try {
        appState.testData.lastUpdated = new Date().toString();
        appState.testData.answers = appState.userAnswers;
        appState.testData.lastQuestionIndex = appState.currentQuestionIndex;
        appState.testData.testKey = testSelect.value;
        await database.ref(`users/${appState.currentUser.uid}/tests/inProgress`).set(appState.testData);
        const prog = (appState.currentQuestionIndex/appState.testQuestions.length)*100;
        homeElements.testProgress.style.width = prog+'%';
      } catch(e){ console.error(e); }
    }

    function showPage(p){ Object.values(pages).forEach(pg=>pg.style.display='none'); p.style.display='block'; }
    function showHomePage(name){
      showPage(pages.home);
      homeElements.startTestButton.disabled = false;
      document.getElementById('email').value='';
      document.getElementById('password').value='';
      document.getElementById('name').value='';
      homeElements.welcomeMessage.textContent = `Hello, ${name}!`;
    }
    function showTestPage(){
      showPage(pages.test);
      displayQuestion();
      startTimer();
    }
    function showResultsPage(score, pct, timeTaken){
      showPage(pages.results);
      resultsElements.scoreDisplay.textContent = `${score}/${appState.testQuestions.length}`;
      resultsElements.percentageDisplay.textContent = `${pct}%`;
      const m = Math.floor(timeTaken/60), s=timeTaken%60;
      resultsElements.timeTakenDisplay.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function showAuthPage(){
      showPage(pages.auth);
      appState.isLoginMode=true;
      authElements.title.textContent='Sign In';
      authElements.button.textContent='Sign In';
      authElements.toggleText.textContent="Don't have an account?";
      authElements.toggleLink.textContent='Sign Up';
      authElements.nameGroup.style.display='none';
    }

    // Implement displayQuestion, startTimer, updateTimerDisplay, stopTimer,
    // submit handler, review handler, logout handler exactly as before,
    // so I haven’t repeated them here to keep this snippet focused on test-selection.
  </script>
</body>
</html>
